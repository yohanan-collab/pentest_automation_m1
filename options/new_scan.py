import re
from colorama import Fore
import nmap
from tabulate import tabulate
import vulners



def extract_version(version_string):
    # Utilisation d'une expression régulière pour extraire la version principale (par exemple, "7.6")
    version_match = re.search(r'(\d+\.\d+\.\d+)', version_string)
    if version_match:
        return version_match.group(1)
    else:
        return ''

def Nmap(ip, html_render=False):
    nm = nmap.PortScanner()
    nm.scan(ip, '21-443')

    results = []
    if html_render:
        table_html = "<table><tr><th>Host</th><th>Port</th><th>Service</th><th>Version</th></tr>"
        for host in nm.all_hosts():
            for proto in nm[host].all_protocols():
                ports = nm[host][proto].keys()
                for port in ports:
                    state = nm[host][proto][port]['state']
                    if state == 'open':
                        service = nm[host][proto][port]['name']
                        version = extract_version(nm[host][proto][port]['version']) if 'version' in nm[host][proto][port] else ''
                        table_html += f"<tr><td>{host}</td><td>{port}</td><td>{service}</td><td>{version}</td></tr>"
        table_html += "</table>"
        return table_html

        
    else:
        for host in nm.all_hosts():
            for proto in nm[host].all_protocols():
                ports = nm[host][proto].keys()
                for port in ports:
                    state = nm[host][proto][port]['state']
                    if state == 'open':
                        service = nm[host][proto][port]['name']
                    version = extract_version(nm[host][proto][port]['version']) if 'version' in nm[host][proto][port] else ''
                    results.append([host, port, service, version])
        return results           


