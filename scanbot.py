import subprocess
import sys
import colorama
import getpass
from colorama import Fore, Back, Style
from options.new_scan import Nmap, nouveau_scan
from options.osint import osint
from options.password_analysis import password_strength
from options.password_analysis import analyze_password_from_keepass_file
from menu import Dashboard, ExploitMenu, OsintMenu, PasswordAnalyze, TargetMenu, displayMenu
from menu import displayHeader
from options.report_pdf import report_pdf
from options.search_cve import search_cve
from multiprocessing import Process
import sys
sys.path.append('/workspace/pentest_automation_m1/options/')
colorama.init()
displayHeader()

def start_dash_app():
    dash_process = subprocess.Popen(["python", "options/generate_dashboard.py"])
    dash_process.wait()
    
def Menu():
    while True:
        displayMenu()
        choice = input(">>> Choose an option\n>>> ")
        if choice == '1':
            TargetMenu()
            subOption = input(">>> Choose an option\n>>> ")
            while subOption != 'z':
                if subOption == 'a':
                    nouveau_scan()
        elif choice == '2':
            report_pdf()
        elif choice == '3':
            ExploitMenu()
            subOption = input(">>> Choose an option\n>>> ")
            while subOption != 'z':
                if subOption == 'a':
                    search_cve()
        elif choice == '4':
            PasswordAnalyze()
            subOption = input(Fore.BLUE + ">>> Choose an option\n>>> ")
            while subOption != 'z':
                if subOption == 'a':
                    while True:
                        password = input(Fore.BLUE + ">>> Enter the password\n>>> ")
                        if not password:
                            break
                        result = password_strength(password)
                        print(result)
                        while True:
                            print(Fore.BLUE + ">>> Do you want to analyze another password? (y/n)")
                            answer = input(Fore.BLUE + ">>> ").lower()
                            if answer == 'y':
                                break
                            elif answer == 'n':
                                Menu()
                            else:
                                print(Fore.RED + ">>> Invalid response, please enter 'y' or 'n'.")
                elif subOption == 'b':
                    file_path = input(Fore.BLUE + '>>> Enter the Keepass file path:\n>>> ')
                    password = getpass.getpass(Fore.BLUE + '>>> Enter the Keepass file password:\n>>> ')

                    weak_passwords = analyze_password_from_keepass_file(file_path, password)
                    if weak_passwords:
                        Menu()
                    else:
                        print(Fore.GREEN + 'No weak passwords detected.')
                        Menu()
        elif choice == '5':
            OsintMenu()
            subOption = input(">>> Choose an option\n>>> ")
            while subOption != 'z':
                if subOption == 'a':
                    osint()
                    break
        elif choice == '6':
            Dashboard()
            subOption = str(input(">>> Choose an option\n>>> "))
            while subOption != 'z':
                if subOption == 'a':
                    target = str(input(">>> Enter the target\n>>> "))

                    start_dash_app()
                    print("Dashboard started.")
                    input("Press Enter to return to the main menu...")
                    Menu()
                    break
        elif choice == '99':
            print(Fore.RED + "Goodbye!")
            sys.exit()
        else:
            print(Fore.RED + "Invalid choice, please try again.")

# L'appel à la fonction Menu pour démarrer le programme
Menu()
Menu()
