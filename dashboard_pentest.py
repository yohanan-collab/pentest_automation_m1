import os
import re
import subprocess
import dash
from dash import Dash, dcc, html, dash_table, Input, Output, State, callback_context,ALL
import dash_bootstrap_components as dbc
import dash_mantine_components as dmc
from dash_iconify import DashIconify
import plotly.graph_objects as go
import pandas as pd
import xmltodict
import json
from datetime import datetime
from dash.exceptions import PreventUpdate


app = dash.Dash(__name__, external_stylesheets=[dbc.themes.SPACELAB, dbc.icons.FONT_AWESOME], suppress_callback_exceptions=True,title="Pentest automation")


server = app.server

# df_ports_services = pd.DataFrame({
#     'Port': [22, 80, 443, 8080],
#     'Statut': ['Ouvert', 'Fermé', 'Filtré', 'Ouvert']
# })

json_file_path = 'output.json'

# Chargement des données JSON
with open(json_file_path, 'r') as file:
    data = json.load(file)

# Extraction des informations de port
ports_data = data['nmaprun']['host']['ports']['port']

# Préparation de la liste pour stocker les données extraites
extracted_data = []

for port in ports_data:
    if isinstance(port, dict):  # S'assurer que la donnée est bien un dictionnaire
        port_id = port['@portid']
        state = port['state']['@state']
        service_name = port.get('service', {}).get('@name', 'unknown')
        if state == 'open':
            extracted_data.append({'Port': port_id, 'State': state, 'Service': service_name})

# Conversion de la liste en DataFrame
df_ports_services = pd.DataFrame(extracted_data)
nombre_ports_ouverts = len(df_ports_services)

df_vulnerabilities = pd.DataFrame({
    'Vulnérabilité': ['Haute', 'Moyenne', 'Critique', 'Faible'],
    'Nombre': [10, 15, 5, 20]
})

DIGIT_REGEX = re.compile(r"\d")
UPPERCASE_REGEX = re.compile(r"[A-Z]")
LOWERCASE_REGEX = re.compile(r"[a-z]")
SPECIAL_CHAR_REGEX = re.compile(r"[!@#$%^&*(),.<>{}\[\]\\;':\"/?|`~\-=_+]")

def password_strength(password):
    length = len(password)
    digit = bool(DIGIT_REGEX.search(password))
    uppercase = bool(UPPERCASE_REGEX.search(password))
    lowercase = bool(LOWERCASE_REGEX.search(password))
    special_char = bool(SPECIAL_CHAR_REGEX.search(password))
    
    # Critères simplifiés pour l'exemple, à ajuster selon vos besoins
    if length >= 12 and digit and uppercase and lowercase and special_char:
        return 'Fort'
    elif length >= 8:
        return 'Moyen'
    else:
        return 'Faible'

def analyze_passwords_from_file(file_path):
    password_strength_counts = {'Faible': 0, 'Moyen': 0, 'Fort': 0}

    with open(file_path, 'r') as file:
        for password in file:
            password = password.strip()
            strength_category = password_strength(password)
            password_strength_counts[strength_category] += 1

    return password_strength_counts


file_path = 'passwords_to_check.txt'

password_strength_counts = analyze_passwords_from_file(file_path)

df_password_analysis = pd.DataFrame(list(password_strength_counts.items()), columns=['Niveau de Sécurité', 'Nombre'])


df_authentication_tests = pd.DataFrame({
    'Test ID': [1, 2, 3, 4],
    'Résultat': ['Réussi', 'Échoué', 'Réussi', 'Échoué']
})

file_path = 'pentest_results.json'

with open(file_path, 'r') as file:
    pentest_results = json.load(file)

hostnames = [target["Hostname"] for target in pentest_results["Target"]]
scan_time = [target["Last Scan Time"] for target in pentest_results["Target"]]

hostnames = list(reversed(hostnames))
scan_time = list(reversed(scan_time))

first_hostnames = hostnames[0]

df_hostnames = pd.DataFrame({"Hostname": hostnames , "Last Scan Time": scan_time})

fig_ports_services = go.Figure(data=[go.Bar(x=df_ports_services['Port'], y=df_ports_services['Service'], text=df_ports_services['State'])])
fig_ports_services.update_layout(title="Ports et Services", xaxis_title="Port", yaxis_title="Service")


fig_vulnerabilities = go.Figure(data=[go.Pie(labels=df_vulnerabilities['Vulnérabilité'], values=df_vulnerabilities['Nombre'])])
fig_vulnerabilities.update_layout(title="Vulnérabilités")


fig_password_analysis = go.Figure(data=[go.Histogram(x=df_password_analysis['Niveau de Sécurité'], y=df_password_analysis['Nombre'])])
fig_password_analysis.update_layout(title="Analyse des Mots de Passe")


fig_authentication_tests = go.Figure(data=[go.Bar(x=df_authentication_tests['Test ID'], y=df_authentication_tests['Résultat'])])
fig_authentication_tests.update_layout(title="Tests d'Authentification")


def get_icon(icon):
    return DashIconify(icon=icon, height=16)


app.layout = dmc.MantineProvider(
    withGlobalStyles=True, 
    children=[
        dmc.Header(
            height=70,
            fixed=True,
            style={
                "zIndex": "1",
                "backgroundColor": "rgb(34, 139, 230)",
                "width": "100%",
            },
            children=[
                dmc.Container(
                    fluid=True,
                    children=[
                        dmc.Group(
                            position="apart",
                            children=[
                                dmc.Anchor(
                                    "OoVulnScan",
                                    href="/",
                                    style={
                                        "color": "white",
                                        "fontFamily": "'Arial', sans-serif",
                                        "fontSize": "30px",
                                        "padding": "10px",
                                    }
                                ),
                                dmc.MantineProvider(
                                    inherit=True,
                                    theme={
                                        "components": {
                                            "Badge": {
                                                "styles": {
                                                    "root": {"borderWidth": 1, "height": 30, "padding": 10, "color": "white"},
                                                    "inner": {"fontWeight": 500},
                                                }
                                            }
                                        }
                                    },
                                    children=[dmc.Badge(f"Cible actuelle : {first_hostnames}", variant="dot",color='green')],
                                )
                                
                            ]
                        )
                    ]
                )
            ]
        ),
        dmc.Navbar(
            fixed=True,
            width={"base": 300},
            position={"top": 0, "left": 0},
            bg = 'rgb(248, 248, 248)',
            withBorder =True,
            zIndex=1,
            children=[
                dmc.ScrollArea(
                    offsetScrollbars=True,
                    type="scroll",
                    children=[
                        
                        html.Br(),
                        html.Div(
                            style={'position': 'relative', 'text-align': 'center'}, 
                            children=[
                                html.Hr(style={'border-top': '2px solid black', 'margin-top': '10px','margin-bottom': '30px'}),
                                html.Span("Scan", 
                                        style={'position': 'absolute', 'left': '50%', 'top': '50%', 'transform': 'translate(-50%, -50%)',
                                                'background-color': 'rgb(248, 248, 248)', 'padding': '0 8px'}),
                            ]
                        ),
                        html.Div(
                            [
                                dmc.NavLink(
                                    label="Nouveau Scan",
                                    icon=get_icon(icon="tabler:search"),
                                    rightSection=get_icon(icon="tabler-chevron-right"),
                                    variant="filled",
                                    href="/new-scan",
                                    active=True,
                                ),
                                dmc.NavLink(
                                    label="Derniers scans",
                                    icon=get_icon(icon="tabler:database"),
                                    rightSection=get_icon(icon="tabler-chevron-right"),
                                    variant="subtle",
                                    href="/dernier-scan",
                                    active=True,
                                ),                               
                            ],
                            className="nav flex-column",
                        ),
                        html.Br(),
                        html.Div(
                            style={'position': 'relative', 'text-align': 'center'}, 
                            children=[
                                html.Hr(style={'border-top': '2px solid black', 'margin-top': '20px','margin-bottom': '30px'}),
                                html.Span("Visualisation", 
                                        style={'position': 'absolute', 'left': '50%', 'top': '50%', 'transform': 'translate(-50%, -50%)',
                                                'background-color': 'rgb(248, 248, 248)', 'padding': '0 8px'}),
                            ]
                        ),
                        html.Div(
                            [
                                dmc.NavLink(
                                    label="Dashboard",
                                    icon=get_icon(icon="tabler:chart-pie"),
                                    rightSection=get_icon(icon="tabler-chevron-right"),
                                    variant="filled",
                                    href="/dashboard",
                                    active=True,
                                ),
                                dmc.NavLink(
                                    label="Ports and Services",
                                    icon=get_icon(icon="tabler:network"),
                                    rightSection=get_icon(icon="tabler-chevron-right"),
                                    variant="subtle",
                                    href="/ports-services",
                                    active=True,
                                ),
                                dmc.NavLink(
                                    label="Vulnerabilities",
                                    icon=get_icon(icon="tabler:virus"),
                                    rightSection=get_icon(icon="tabler-chevron-right"),
                                    variant="subtle",
                                    href="/vulnerabilities",
                                    active=True,
                                ),
                                dmc.NavLink(
                                    label="Password Analysis",
                                    icon=get_icon(icon="tabler:lock-open"),
                                    rightSection=get_icon(icon="tabler-chevron-right"),
                                    variant="subtle",
                                    href="/password-analysis",
                                    active=True,
                                ),
                                dmc.NavLink(
                                    label="Authentication Tests",
                                    icon=get_icon(icon="tabler:user"),
                                    rightSection=get_icon(icon="tabler-chevron-right"),
                                    variant="subtle",
                                    href="/authentication-tests",
                                    active=True,
                                ),
                                dmc.NavLink(
                                    label="Rapports",
                                    icon=get_icon(icon="tabler:file"),
                                    rightSection=get_icon(icon="tabler-chevron-right"),
                                    href="/rapports",
                                    active=True,
                                ),                                
                            ],
                            className="nav flex-column",
                        )
                    ]
                )
            ]
        ),

        dmc.Container(
            fluid=True,
            children=[
                html.Div(id='content')
            ],
            style={"marginLeft": "300px" ,"marginTop":"80px"}
        ),

        dcc.Location(id='url'),
    ]
)


@app.callback(
    Output('content', 'children'),
    [Input('url', 'pathname')],
    
)
def display_page(pathname):
    if pathname == '/':
        return home()
    elif pathname == '/dashboard':
        return dashboard_layout()
    elif pathname == '/new-scan':
        return initial_content()
    elif pathname == '/dernier-scan':
        return dernier_scan()
    elif pathname == '/ports-services':
        return ports_services_layout()
    elif pathname == '/vulnerabilities':
        return vulnerabilities_layout()
    elif pathname == '/password-analysis':
        return password_analysis_layout()
    elif pathname == '/authentication-tests':
        return authentication_tests_layout()
    elif pathname == '/rapports':
        return rapports_layout()
    else:
        return "Page not found"
def home():
    ascii_art = """
   
 ▒█████   ▒█████   ██▒   █▓ █    ██  ██▓     ███▄    █   ██████  ▄████▄   ▄▄▄       ███▄    █ 
▒██▒  ██▒▒██▒  ██▒▓██░   █▒ ██  ▓██▒▓██▒     ██ ▀█   █ ▒██    ▒ ▒██▀ ▀█  ▒████▄     ██ ▀█   █ 
▒██░  ██▒▒██░  ██▒ ▓██  █▒░▓██  ▒██░▒██░    ▓██  ▀█ ██▒░ ▓██▄   ▒▓█    ▄ ▒██  ▀█▄  ▓██  ▀█ ██▒
▒██   ██░▒██   ██░  ▒██ █░░▓▓█  ░██░▒██░    ▓██▒  ▐▌██▒  ▒   ██▒▒▓▓▄ ▄██▒░██▄▄▄▄██ ▓██▒  ▐▌██▒
░ ████▓▒░░ ████▓▒░   ▒▀█░  ▒▒█████▓ ░██████▒▒██░   ▓██░▒██████▒▒▒ ▓███▀ ░ ▓█   ▓██▒▒██░   ▓██░
░ ▒░▒░▒░ ░ ▒░▒░▒░    ░ ▐░  ░▒▓▒ ▒ ▒ ░ ▒░▓  ░░ ▒░   ▒ ▒ ▒ ▒▓▒ ▒ ░░ ░▒ ▒  ░ ▒▒   ▓▒█░░ ▒░   ▒ ▒ 
  ░ ▒ ▒░   ░ ▒ ▒░    ░ ░░  ░░▒░ ░ ░ ░ ░ ▒  ░░ ░░   ░ ▒░░ ░▒  ░ ░  ░  ▒     ▒   ▒▒ ░░ ░░   ░ ▒░
░ ░ ░ ▒  ░ ░ ░ ▒       ░░   ░░░ ░ ░   ░ ░      ░   ░ ░ ░  ░  ░  ░          ░   ▒      ░   ░ ░ 
    ░ ░      ░ ░        ░     ░         ░  ░         ░       ░  ░ ░            ░  ░         ░ 
                       ░                                        ░                             

    """
    return html.Div([
        dmc.Container([
            dmc.Paper([
                html.Pre(ascii_art, style={"white-space": "pre", "font-family": "monospace", "font-size": "23px"}),
            ], p="lg", ta="center",style={"overflow": "auto","maxWidth": "100%"}),

            

            dmc.Title("Welcome to the Security Toolkit", order=2,align="center"),

            dmc.Space(h="md"),

            dmc.Text("Your one-stop solution for security scanning and analysis. Navigate through the application to access various tools designed to enhance your cybersecurity posture.", align="center"),

            dmc.Space(h="md"),

            dmc.Group([
                dmc.Button("Start Scanning", variant="filled", color="green"),
                dmc.Button("Learn More", variant="outline", color="blue")
            ], position="center", spacing="xl")
        ],style={ "maxWidth": "1300px", "margin": "0 auto"} ),
    ], style={"padding": "40px"})

def initial_content():
    return html.Div([
        html.Div([
            dmc.Title("Nouveau Scan", order=2, align="center", style={"margin": "20px 0","font-size":"50px"}),
            dmc.TextInput(
                id='target-input',
                placeholder='Enter target for scanning',
                style={
                    "marginBottom": "20px",
                    "width": "100%",  # Utilisez 100% de la largeur du conteneur
                    "maxWidth": "500px",  # Limitez la largeur maximale pour une apparence soignée
                    "margin": "0 auto"  # Centre le TextInput horizontalement
                }
            ),
            dmc.Button(
                "Start Scan",
                id="start-scan-btn",
                n_clicks=0,
                style={
                    "display": "block",  # Assurez que le bouton soit un bloc pour permettre le centrage
                    "margin": "0 auto",  # Centre le bouton horizontalement
                    "marginTop": "10px"
                },
                color="blue",  # Changez la couleur du bouton (si supporté par le composant)
                variant="filled"  # Utilisez une variante remplie pour plus de visibilité
            )
        ], id='initial-content', style={"textAlign": "center"}),
        html.Div(id='new-scan-content'),
        html.Div(id='scan-results')
    ], style={
        "display": "flex",
        "flexDirection": "column",
        "alignItems": "center",
        "justifyContent": "center",
        
        "height": "90vh"  # Utilisez toute la hauteur de la fenêtre de visualisation pour le centrage vertical
    })


@app.callback(
    Output('initial-content', 'children'),  # On va vider le contenu initial
    Output('new-scan-content', 'children'),  # On va remplir ce conteneur avec le nouveau contenu
    Output('scan-results', 'children',allow_duplicate=True),  # Afficher un message de confirmation
    Input('start-scan-btn', 'n_clicks'),
    State('target-input', 'value'),
    prevent_initial_call=True
)
def update_content(n_clicks, hostname):
    if n_clicks > 0 and hostname:
        json_file_path="pentest_results.json"
        # Charger le fichier JSON existant ou initialiser si non existant
        if os.path.exists(json_file_path):
            with open(json_file_path, 'r') as file:
                data = json.load(file)
        else:
            data = {"Target": []}
        
        scan_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        # Ajouter le nouveau hostname avec l'heure du scan à la liste
        data["Target"].append({"Hostname": hostname, "Last Scan Time": scan_time})        
        # Sauvegarder les modifications dans le fichier JSON
        with open(json_file_path, 'w') as file:
            json.dump(data, file, indent=4)
        
        # Générer le nouveau contenu après le clic sur le bouton
        new_content = html.Div([
                            dmc.Container([
                                dmc.Title("Nouveau Scan", order=2,align="center"),
                                dmc.Tabs(
                                    value='Recon',
                                    id='tabs',
                                    children=[
                                        dmc.TabsList(
                                            position="center",
                                            grow=True,
                                            children=[
                                                dmc.Tab("Recon", value="Recon"),
                                                dmc.Tab("Scanning", value="Scanning"),
                                                dmc.Tab("Exploit", value="Exploit"),
                                                dmc.Tab("OSINT", value="OSINT"),
                                            ],
                                        ),
                                        dmc.TabsPanel(value="Recon", children=generate_form_for_recon()),
                                        dmc.TabsPanel(value="Scanning", children=generate_form_for_scanning()),
                                        dmc.TabsPanel(value="Exploit", children=generate_form_for_exploit()),
                                        dmc.TabsPanel(value="OSINT", children=generate_form_for_osint()),
                                    ],
                                    color="red",
                                    orientation="horizontal",
                                ),
                                dmc.Button("Show Active Options", id="btn-show-active", style={"marginTop": "20px"}),
                                html.Div(id="active-options-display")
                            ]),
                            dcc.Store(id='switches-state', data={})
                        ])
        
        confirmation_message = f"Hostname {hostname} ajouté avec succès au fichier JSON."
        
        # Vider le contenu initial et retourner le nouveau contenu et le message de confirmation
        return None, new_content, confirmation_message
    
    return dash.no_update, dash.no_update, "Veuillez entrer un hostname valide."


def convert_xml_json():
    xml_file_path = 'nmap_out.xml'
    json_file_path = 'output.json'
    with open(xml_file_path, 'r', encoding='utf-8') as xml_file:
        xml_content = xml_file.read()

    dict_data = xmltodict.parse(xml_content)

    with open(json_file_path, 'w', encoding='utf-8') as json_file:
        json.dump(dict_data, json_file, ensure_ascii=False, indent=4)

@app.callback(
    Output('nmap-output', 'children'),  # Changez ici pour afficher les résultats du scan
    Input('nmap-button', 'n_clicks'),
    State('nmap-checkbox', 'checked')  # Ajoutez l'état de la case à cocher comme un état à vérifier
)

def execute_nmap_scan(n_clicks, is_checked):
    if n_clicks is None or not is_checked:
        return dash.no_update

    target = last_target_from_json()

    try:
        command = ['nmap', '-A', '-T4', '-oX', 'nmap_out.xml', target]
        subprocess.run(command, check=True, capture_output=True)
        scan_result = f"Nmap scan executed successfully for {target}."
        convert_xml_json()

        return scan_result
    except subprocess.CalledProcessError as e:
        return f"Error executing Nmap scan: {e}"

def last_target_from_json(json_file_path="pentest_results.json"):
    """Extrait la dernière cible enregistrée dans le fichier JSON."""
    if os.path.exists(json_file_path):
        with open(json_file_path, 'r') as file:
            data = json.load(file)
        if data["Target"]:
            return data["Target"][-1]["Hostname"]
    return None

def generate_switch_with_label(id, label):
    switch_container_style = {
        "marginBottom": "20px", 
        "display": "flex",
        "flexDirection": "column",
        "justifyContent": "center", 
        "width": "100%"
    }
    
    label_style = {
        "fontSize": "18px", 
        "fontWeight": "bold", 
        "marginBottom": "10px",
    }
    
    
    return html.Div([
        dmc.Text(label, style=label_style),
        dmc.Switch(id={'type': 'dynamic-switch', 'index': id,'label': label}, offLabel="OFF", onLabel="ON"),
    ], style=switch_container_style)

def generate_form_for_recon():
    return dmc.Group(
        
        position="center",
        spacing="md",
        children=[
            generate_switch_with_label("switch-whois", "Basic Whois request"),
            generate_switch_with_label("switch-cve", "Look for a CVE"),
            generate_switch_with_label("switch-dns", "Get DNS related data on a domain"),
            generate_switch_with_label("switch-http", "Get data about a http/https certificate"),
        ]
    )

@app.callback(
    Output('nmap-output', 'style'),
    [Input('nmap-output', 'children')]
)
def update_output_style(content):
    if content:
        return {"marginTop": "20px", "padding": "10px", "border": "1px solid #CCC", "borderRadius": "5px", "backgroundColor": "#F8F8F8"}
    else:
        return {}  # Retourne un style vide ou minimal si pas de contenu

def generate_form_for_scanning():
    return dmc.Paper(  # Utilisez Paper ou Card pour un effet de fond et une ombre
        p="md",  # Ajoute du padding autour des éléments internes
        withBorder=True,  # Ajoute une bordure autour du Paper
        shadow="xs",  # Définit l'intensité de l'ombre
        radius="md",  # Arrondit les coins du Paper
        style={"maxWidth": "600px", "margin": "auto", "marginTop": "20px"},  # Centre le formulaire et ajoute une marge en haut
        children=[
            dmc.Title("Nmap Scanner", order=4, align="center", style={"marginBottom": "20px"}),  # Titre optionnel pour le formulaire
            dmc.Group(
                position="center",
                spacing="md",
                children=[
                    dmc.Checkbox(id='nmap-checkbox', label='Scan nmap', size="md"),  # Augmente la taille de la checkbox
                    dmc.Button('Start Nmap Scan', id='nmap-button', variant="filled", color="blue", style={"marginTop": "10px"}),
                    html.Div(id='nmap-output')  # Stylise la div de sortie
                ]
            )
        ]
    )

def generate_form_for_exploit():
    return dmc.Group(
        position="center",
        spacing="md",
        children=[
            generate_switch_with_label("switch-exploit-search", "Search for vuln and exploits on a service"),
        ]
    )

def generate_form_for_osint():
    return dmc.Group(
        
        position="center",
        spacing="md",
        children=[
            generate_switch_with_label("switch-username-search", "Look for username on social medias"),
            generate_switch_with_label("switch-phone-lookup", "Reverse phone number lookup"),
            generate_switch_with_label("switch-fake-identity", "Fake identity generator"),
            generate_switch_with_label("switch-dorks", "Dorks research"),
        ]
    )

def dernier_scan():
    return dbc.Row([
                html.Div(
                    style={'position': 'relative', 'text-align': 'center'}, 
                    children=[
                        html.Hr(style={'border-top': '5px solid rgb(134, 142, 150)', 'margin-top': '20px'}),
                        dmc.Title("Derniers Scans réalisés", order=1,style={'position': 'absolute', 'left': '50%', 'top': '50%', 'transform': 'translate(-50%, -50%)',
                                        'background-color': 'white', 'padding': '0 20px'})
                       
                    ]
                ),
                dbc.Col(
                        dbc.Tab(label="Derniers Scans réalisés", 
                        children=[html.Div(generate_table(df_hostnames),className="mb-2")
                        ]),
                            width=12,
                            lg=9,     
                ),

            ],justify='center')   

def dashboard_layout():
    return html.Div([
        dbc.Container([
            html.Div(
                    style={'position': 'relative', 'text-align': 'center'}, 
                    children=[
                        html.Hr(style={'border-top': '5px solid rgb(134, 142, 150)', 'margin-top': '20px'}),
                        html.Span("Statistiques", 
                                style={'position': 'absolute', 'left': '50%', 'top': '50%', 'transform': 'translate(-50%, -50%)',
                                        'background-color': 'white', 'padding': '0 10px'}),
                    ]
                ),
            dmc.Group(
                [
                    dmc.RingProgress(
                        id="ring-progress-1",
                        size=200,
                        sections=[{"value": 10, "color": "indigo"}],
                        label=dmc.Center(dmc.Text(f"{nombre_ports_ouverts} ports ouverts", color="indigo")),
                    ),
                    dmc.RingProgress(
                        id="ring-progress-2",
                        size=200,
                        sections=[{"value": 33, "color": "indigo"}],
                        label=dmc.Center(dmc.Text(f"{password_strength_counts['Faible']} passwords faibles", color="indigo")),
                    ),
                    dmc.RingProgress(
                        id="ring-progress-3",
                        size=200,
                        sections=[{"value": 20, "color": "indigo"}],
                        label=dmc.Center(dmc.Text("10 vulnérabilités critiques", color="indigo",align='center')),
                    ),
                    dmc.RingProgress(
                        id="ring-progress-4",
                        size=200,
                        sections=[{"value": 50, "color": "indigo"}],
                        label=dmc.Center(dmc.Text("2 tests réussis", color="indigo",align='center')),
                    ),
                ],
                position ="center",  
            ),
            html.Div(
                    style={'position': 'relative', 'text-align': 'center'}, 
                    children=[
                        html.Hr(style={'border-top': '5px solid rgb(134, 142, 150)', 'margin-top': '20px'}),
                        html.Span("Visualisation", 
                                style={'position': 'absolute', 'left': '50%', 'top': '50%', 'transform': 'translate(-50%, -50%)',
                                        'background-color': 'white', 'padding': '0 10px'}),
                    ]
                ),
        ]),
        dbc.Container([
            dbc.Row([
                dbc.Col([
                    html.Div([
                        dcc.Graph(figure=fig_ports_services)
                    ], style={'border': '1px solid #ddd', 'padding': '15px', 'borderRadius': '5px','boxShadow': '0 4px 8px rgba(0, 0, 0, 0.1)'}), 
                ], width=12, lg=6),

                dbc.Col([
                    html.Div([
                        dcc.Graph(figure=fig_vulnerabilities)
                    ], style={'border': '1px solid #ddd', 'padding': '15px', 'borderRadius': '5px','boxShadow': '0 4px 8px rgba(0, 0, 0, 0.1)'}),
                ], width=12, lg=6),
            ], justify="center",style={"marginBottom":"20px","marginTop":"95px"}),

            dbc.Row([
                dbc.Col([
                    html.Div([
                        dcc.Graph(figure=fig_password_analysis)
                    ], style={'border': '1px solid #ddd', 'padding': '15px', 'borderRadius': '5px','boxShadow': '0 4px 8px rgba(0, 0, 0, 0.1)'}),
                ], width=12, lg=6),

                dbc.Col([
                    html.Div([
                        dcc.Graph(figure=fig_authentication_tests)
                    ], style={'border': '1px solid #ddd', 'padding': '15px', 'borderRadius': '5px','boxShadow': '0 4px 8px rgba(0, 0, 0, 0.1)'}),
                ], width=12, lg=6),
            ], justify="center",style={"marginBottom":"20px"}),
        ], fluid=True, className="ms-1")
    ])

def generate_table(dataframe):
    header = html.Thead(
        html.Tr([html.Th(col) for col in dataframe.columns])
    )

    rows = []
    for i, row in dataframe.iterrows():
        bgcolor = 'rgb(248, 248, 248)' if i % 2 == 1 else 'white'
        cells = [html.Td(data) for data in row]
        rows.append(html.Tr(cells, style={'backgroundColor': bgcolor}))

    table_body = html.Tbody(rows)

    table = dmc.Table(
        verticalSpacing="sm",
        horizontalSpacing=10,
        children=[header, table_body],
        style={'overflowX': 'auto', 'textAlign': 'left', 'width': '100%'}
    )

    # Style pour le div contenant le tableau pour permettre le défilement vertical
    table_container_style = {
        'maxHeight': '400px',  # Définir une hauteur maximale pour le conteneur
        'overflowY': 'auto'    # Permettre le défilement vertical
    }

    box_style = {
        'border': '1px solid lightgrey',
        'boxShadow': '0 2px 4px rgba(0,0,0,.1)',
        'borderRadius': '5px',
        'padding': '10px',
        'marginTop': '20px',
        'marginBottom': '20px'
    }

    # Envelopper le tableau dans un div avec un style pour le défilement vertical
    return html.Div(
        html.Div(table, style=table_container_style),  # Div pour le défilement
        style=box_style
    )



def ports_services_layout():
    return dbc.Row([
                html.Div(
                    style={'position': 'relative', 'text-align': 'center'}, 
                    children=[
                        html.Hr(style={'border-top': '5px solid rgb(134, 142, 150)', 'margin-top': '20px'}),
                        html.Span("Ports and Services", 
                                style={'position': 'absolute', 'left': '50%', 'top': '50%', 'transform': 'translate(-50%, -50%)',
                                        'background-color': 'white', 'padding': '0 10px'}),
                    ]
                ),
                dbc.Col(
                        dbc.Tab(label="Ports and Services", 
                        children=[html.Div(generate_table(df_ports_services),className="mb-2")
                        ]),
                            width=12,
                            lg=9,     
                ),

            ],justify='center')
      
            
def vulnerabilities_layout():
    return dbc.Row([
                html.Div(
                    style={'position': 'relative', 'text-align': 'center'}, 
                    children=[
                        html.Hr(style={'border-top': '5px solid rgb(134, 142, 150)', 'margin-top': '20px'}),
                        html.Span("Vulnérabilités Détectées", 
                                style={'position': 'absolute', 'left': '50%', 'top': '50%', 'transform': 'translate(-50%, -50%)',
                                        'background-color': 'white', 'padding': '0 10px'}),
                    ]
                ),
                dbc.Col(
                        dbc.Tab(label="Vulnérabilités Détectées", 
                        children=[html.Div(generate_table(df_vulnerabilities),className="mb-2")
                        ]),
                            width=12,
                            lg=9,     
                ),

            ],justify='center')

def password_analysis_layout():
    return dbc.Row([
                html.Div(
                    style={'position': 'relative', 'text-align': 'center'}, 
                    children=[
                        html.Hr(style={'border-top': '5px solid rgb(134, 142, 150)', 'margin-top': '20px'}),
                        html.Span("Analyse des Mots de Passe", 
                                style={'position': 'absolute', 'left': '50%', 'top': '50%', 'transform': 'translate(-50%, -50%)',
                                        'background-color': 'white', 'padding': '0 10px'}),
                    ]
                ),
                dbc.Col(
                        dbc.Tab(label="Analyse des Mots de Passe", 
                        children=[html.Div(generate_table(df_password_analysis),className="mb-2")
                        ]),
                            width=12,
                            lg=9,     
                ),

            ],justify='center') 

def authentication_tests_layout():
    return dbc.Row([
                html.Div(
                    style={'position': 'relative', 'text-align': 'center'}, 
                    children=[
                        html.Hr(style={'border-top': '5px solid rgb(134, 142, 150)', 'margin-top': '20px'}),
                        html.Span("Tests d'Authentification", 
                                style={'position': 'absolute', 'left': '50%', 'top': '50%', 'transform': 'translate(-50%, -50%)',
                                        'background-color': 'white', 'padding': '0 10px'}),
                    ]
                ),
                dbc.Col(
                        dbc.Tab(label="Tests d'Authentification", 
                        children=[html.Div(generate_table(df_authentication_tests),className="mb-2")
                        ]),
                            width=12,
                            lg=9,     
                ),

            ],justify='center')

def rapports_layout():
    rapports = ["rapport1.pdf", "rapport2.pdf", "rapport3.pdf","rapport4.pdf", "rapport5.pdf", "rapport6.pdf"]

    return dmc.Container(
        fluid=True,
        children=[
            dmc.Title("Rapports de Scan", order=3, style={"textAlign": "center", "margin": "40px"}),
            dmc.SimpleGrid(
                cols=4,
                spacing="lg",
                children=[
                    dmc.Card(
                        shadow="sm",
                        p="lg",
                        radius="md",
                        withBorder=True,
                        children=[
                            dmc.Text(rapport, size="md", align="center"),
                            dmc.Button("Télécharger", variant="outline", fullWidth=True, style={"marginTop": "10px"})
                        ]
                    ) for rapport in rapports
                ]
            )
        ]
    )


if __name__ == '__main__':
    app.run_server(debug=True,port='8080')

